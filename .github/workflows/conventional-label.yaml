name: 🏷 Label PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    if: github.event.pull_request.labels.length == 0
    runs-on: ubuntu-latest
    steps:
      - name: "Confirm correct pull request title"
        uses: mmubeen/action-pr-title@master  # until PR gets merged https://github.com/deepakputhraya/action-pr-title/pull/29
        with:
          allowed_prefixes: 'feat,fix,build,ci,refactor,test,style,translation,docs,revert'

      - name: Generate token
        uses: tibdex/github-app-token@v2.1.0
        id: generate_token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
          
      - name: "Apply label"
        uses: bcoe/conventional-release-labels@v1.3.1
        with:          
          token: ${{ steps.generate_token.outputs.token }}
          # Labels assigned based on pr name prefix
          type_labels: >
            {
              "feat": "pull request: feature-minor",
              "fix": "pull request: bug",
              "build": "pull request: maintenance",
              "ci": "pull request: maintenance",
              "refactor": "pull request: maintenance",
              "test": "pull request: maintenance",
              "style": "pull request: maintenance",
              "translation": "pull request: translation",
              "docs": "pull request: documentation",
              "revert": "pull request: skip-changelog"
            }
          # Do not ignore any labels (default ignores chore:)
          ignored_types: '[]'

      - name: debug
        run: |
          echo "${{ toJson(github.event.pull_request.labels) }}"
          echo "${{ toJson(github.event.pull_request.labels.*.names) }}"